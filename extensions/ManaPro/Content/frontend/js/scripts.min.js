/**
 * @category    Mana
 * @package     ManaPro_Content
 * @copyright   Copyright (c) http://www.manadev.com
 * @license     http://www.manadev.com/license  Proprietary License
 */
Mana.define("ManaPro/Content/Filter",["jquery","singleton:Mana/Core/Config"],function(t,e){return Mana.Object.extend("ManaPro/Content/Filter",{_init:function(){this.loadFilterFromUrl()},loadFilterFromUrl:function(){this._searchValue="",this._relatedProducts=[],this._tags=[];var t=window.location.search;t=t.substr(1,t.length-1),t=t.split("&");for(var e,n=0;n<t.length;n++)switch(e=t[n].split("="),e[0]){case"search":this._searchValue=e[1];break;case"related_products":this._relatedProducts=e[1].split(",").map(Number);break;case"tags":this._tags=e[1].split(",").map(Number)}},setSearch:function(t){return this._searchValue=t,this.constructUrl()},getUrlIfTagSelected:function(t){var e=this.addTag(t);return this.removeTag(t),e},getUrlIfTagNotSelected:function(t){var e=this.removeTag(t);return this.addTag(t),e},addTag:function(t){return this.isTagSelected(t)||this._tags.push(t),this.constructUrl()},removeTag:function(e){var n=this;return t.each(this._tags,function(t){return n._tags[t]==e?void n._tags.splice(t,1):void 0}),this.constructUrl()},isTagSelected:function(e){return-1!==t.inArray(e,this._tags)},getUrlIfRelatedProductChecked:function(t){var e=this.addToRelatedProducts(t);return this.removeFromRelatedProduct(t),e},getUrlIfRelatedProductUnchecked:function(t){var e=this.removeFromRelatedProduct(t);return this.addToRelatedProducts(t),e},setRelatedProducts:function(t){return this._relatedProducts=t,this.constructUrl()},addToRelatedProducts:function(t){return this.isProductChecked(t)||this._relatedProducts.push(t),this.constructUrl()},removeFromRelatedProduct:function(e){var n=this;return t.each(this._relatedProducts,function(t){return n._relatedProducts[t]==e?void n._relatedProducts.splice(t,1):void 0}),this.constructUrl()},isProductChecked:function(e){return-1!==t.inArray(e,this._relatedProducts)},constructUrl:function(){var n=e.getData("mana_content.url"),r={};if(this._searchValue.length>0&&(r.search=this._searchValue),this._relatedProducts.length>0&&(r.related_products=this._relatedProducts),this._tags.length>0&&(r.tags=this._tags),r.search||r.related_products||r.tags){n+="?";var a=!0;t.each(r,function(t){a?a=!1:n+="&",n+=t+"="+r[t]})}return n}})}),Mana.define("ManaPro/Content/AjaxInterceptor",["jquery","singleton:Mana/Core/Ajax","singleton:Mana/Core/Config","singleton:Mana/Core/Layout","singleton:ManaPro/Content/Filter"],function(t,e,n,r,a,o){return Mana.Object.extend("ManaPro/Content/AjaxInterceptor",{match:function(e,r){if(r){var a=n.getData("mana_content.ajax.containers");if(a&&t(a).has(r).length>0)return!0}return!1},intercept:function(t){var i=document.createElement("a"),s=!1;i.href=t,window._gaq!==o&&(window._gaq.push(["_setAccount",n.getData("ga.account")]),window._gaq.push(["_trackPageview",t.substring(i.protocol.length+i.hostname.length+2)])),window.ga!==o&&window.ga("send","pageview",{page:t.substring(i.protocol.length+i.hostname.length+2)});var c=t;t=decodeURIComponent(t);var u=c.indexOf("?"),l=t.indexOf("?");-1!=u&&-1!=l&&(t=t.substr(0,l)+"?"+c.substr(u+1));var d=n.getData("url.base");return d+=n.getData("mana_content.ajax.urlKey"),d+="/"+n.getData("ajax.currentRoute"),d+="/"+n.getData("mana_content.ajax.routeSeparator"),d+="/"+t.substr(n.getData("url.base").length),e.get(d,function(t){return a.loadFilterFromUrl(),e.update(t),r.getPageBlock().resize(),s=!0,!0},{preventClicks:!0,encode:-1!=l?{offset:0,length:l}:o}),s}})}),Mana.require(["jquery","singleton:Mana/Core/Ajax","singleton:ManaPro/Content/AjaxInterceptor"],function(t,e,n){e.addInterceptor(n)}),Mana.define("ManaPro/Content/Tree/Search",["jquery","Mana/Core/Block","singleton:Mana/Core/Layout","singleton:Mana/Core/Config","singleton:ManaPro/Content/Filter"],function(t,e,n,r,a){return e.extend("ManaPro/Content/Tree/Search",{_subscribeToHtmlEvents:function(){function t(t){e.changed(),e.submit(),t.preventDefault()}var e=this;return this._super().on("bind",this,function(){this.$form().on("submit",t)}).on("unbind",this,function(){this.$form().off("submit",t)})},_subscribeToBlockEvents:function(){return this._super().on("load",this,function(){this.$field()[0].setValue(a._searchValue)})},submit:function(){this.$link()[0].href=this.$form()[0].action,this.$link().click()},$field:function(){return this.$().find("input")},$form:function(){return this.$().find("form")},$link:function(){return this.$().find("a")},$tree:function(){return n.getBlock("tree")},changed:function(){this.$form()[0].action=a.setSearch(this.$field()[0].getValue())}})}),Mana.define("ManaPro/Content/Tree/RelatedProduct",["jquery","Mana/Core/Block","singleton:ManaPro/Content/Filter"],function(t,e,n){return e.extend("ManaPro/Content/Tree/RelatedProduct",{setFilterUrl:function(t){var e=t.data("mProductId");t.addClass(n.isProductChecked(e)?"m-checkbox-checked":"m-checkbox-unchecked"),t[0].href=t.hasClass("m-checkbox-unchecked")?n.getUrlIfRelatedProductChecked(e):n.getUrlIfRelatedProductUnchecked(e)},_subscribeToBlockEvents:function(){var e=this;return this._super().on("load",this,function(){this.$().find("a").each(function(){e.setFilterUrl(t(this))})})}})}),Mana.define("ManaPro/Content/Tree/Tag",["jquery","Mana/Core/Block","singleton:ManaPro/Content/Filter"],function(t,e,n){return e.extend("ManaPro/Content/Tree/Tag",{setFilterUrl:function(t){var e=t.data("mTagId");n.isTagSelected(e)&&t.addClass("m-tag-selected"),t[0].href=t.hasClass("m-tag-selected")?n.getUrlIfTagNotSelected(e):n.getUrlIfTagSelected(e)},_subscribeToBlockEvents:function(){var e=this;return this._super().on("load",this,function(){this.$().find("a").each(function(){e.setFilterUrl(t(this))})})}})});