/**
 * @category    Mana
 * @package     Mana_InfiniteScrolling
 * @copyright   Copyright (c) http://www.manadev.com
 * @license     http://www.manadev.com/license  Proprietary License
 */
Mana.define("Mana/InfiniteScrolling/Engine",["jquery","Mana/Core/Block","singleton:Mana/Core/Ajax","singleton:Mana/Core/UrlTemplate","singleton:Mana/Core/Layout","singleton:Mana/Core/Config","singleton:Mana/Core/Json"],function(t,e,o,n,i,r,a){return e.extend("Mana/InfiniteScrolling/Engine",{_init:function(){this._super(),this.debugScrolling=!1,this.isShowMoreButtonVisible=1==this.getPagesPerShowMore()},_subscribeToHtmlEvents:function(){function t(){e.onScroll()}var e=this;return this._super().on("bind",this,function(){e.$pager().hide(),e.page=1,e.limit=this.getVisibleItemCount(),e.$scrollingArea().on("scroll",t),this.showShowMoreButton()}).on("unbind",this,function(){e.$scrollingArea().off("scroll",t)})},getContainerSelector:function(){return this.$().data("container")},getRowSelector:function(){return this.getModeHandler().getRowSelector()},getProductCount:function(){return this.$().data("product-count")},getPageSize:function(){return this.$().data("page-size")},getLoaderSelector:function(){return this.getModeHandler().getLoaderSelector()},getPagerSelector:function(){return this.$().data("pager")},getUrlKey:function(){return this.$().data("url-key")},getRouteSeparator:function(){return this.$().data("route-separator")},getPageSeparator:function(){return this.$().data("page-separator")},getLimitSeparator:function(){return this.$().data("limit-separator")},getMode:function(){return this.$().data("mode")},getModeHandler:function(){if(!this.modeHandlers){this.modeHandlers={};var e=a.decodeAttribute(this.$().data("mode-handlers")),o=[],n=this;t.each(e,function(t,e){o.push(e)}),Mana.requireOptional(o,function(){var i=arguments;t.each(e,function(t,e){var r=i[o.indexOf(e)];n.modeHandlers[t]=new r(n,t)})})}return this.modeHandlers[this.getMode()]},getEffectDuration:function(){return this.$().data("effect-duration")},$container:function(){return t(this.getContainerSelector())},$pager:function(){return t(this.getPagerSelector())},$items:function(){return this.getModeHandler().$items()},$rows:function(){return this.getModeHandler().$rows()},$loaderTemplate:function(){return this.$().find(this.getLoaderSelector())},$loader:function(){return this.getModeHandler().$loader()},$loaderLocation:function(){return this.getModeHandler().$loaderLocation()},$scrollingArea:function(){return t(window)},getScrollingAreaBottom:function(){return t(window).scrollTop()+t(window).height()},getProductListBottom:function(){var t=this.$rows().last();return t.offset().top+t.height()},getVisibleItemCount:function(){return this.$items().length},getPagesPerShowMore:function(){return this.$().data("pages-per-show-more")},getRecoverScrollProgressOnBack:function(){return this.$().data("recover-scroll-progress-on-back")},showShowMoreButton:function(){var e=this;if(e.getVisibleItemCount()<e.getProductCount()&&!this.isShowMoreButtonVisible&&e.page%e.getPagesPerShowMore()==0){e.isShowMoreButtonVisible=!0;var o=t("<button id='m-show-more'><span>Show More...</span></button>");o.insertAfter(t(".products-grid").last()),o.addClass("button"),o.on("click",function(){t(this).remove(),e.isShowMoreButtonVisible=!1,e.load(e.page+1,e.limit)})}},load:function(t,e,n){var a=this;a.showLoader();var s=o.getDocumentUrl(),l=s;s=decodeURIComponent(s);var u=l.indexOf("?"),c=s.indexOf("?");-1!=u&&-1!=c&&(s=s.substr(0,c)+"?"+l.substr(u+1)),s=r.getBaseUrl(s)+this.getUrlKey()+"/"+r.getData("ajax.currentRoute")+"/"+this.getPageSeparator()+"/"+(a.page+1)+"/"+this.getLimitSeparator()+"/"+e+"/"+this.getRouteSeparator()+"/"+s.substr(r.getBaseUrl(s).length),o.get(s,function(o){a.addContent(o),a.page++,a.hideLoader(),i.getPageBlock().resize(),a.page==t?(a.showShowMoreButton(),n()):(window.scrollTo(null,a.$rows().last().offset().top-20),a.load(t,e,n))},{showWait:!1,showOverlay:!1,encode:-1!=c?{offset:0,length:c}:void 0})},showLoader:function(){this.loaderVisible=!0,this.$loaderLocation().after(this.$loaderTemplate().clone())},hideLoader:function(){this.loaderVisible=!1,this.$loader().remove()},isLoaderVisible:function(){return this.loaderVisible},addContent:function(e){var o=t(e),n=o.find(this.getRowSelector()),i=this;n.hide(),i.$rows().last().removeClass("last"),n.each(function(){i.$rows().last().after(this)}),n.fadeIn(this.getEffectDuration())},onScroll:function(){this.debugScrolling&&console.log("visible bottom: %d, list bottom: %d, visible count: %d, product count: %d",this.getScrollingAreaBottom(),this.getProductListBottom(),this.getVisibleItemCount(),this.getProductCount()),this.getVisibleItemCount()<this.getProductCount()&&this.getScrollingAreaBottom()>=this.getProductListBottom()&&!this.isLoaderVisible()&&!this.isShowMoreButtonVisible&&this.load(this.page+1,this.limit)}})}),Mana.define("Mana/InfiniteScrolling/ModeHandler",["jquery"],function(){return Mana.Object.extend("Mana/InfiniteScrolling/ModeHandler",{_init:function(t,e){this.engine=t,this.mode=e},getItemSelector:function(){return this.engine.$().data("item-in-"+this.mode+"-mode")},getRowSelector:function(){return this.engine.$().data("row-in-"+this.mode+"-mode")},getLoaderSelector:function(){return this.engine.$().data("loader-in-"+this.mode+"-mode")},$items:function(){return this.engine.$container().find(this.getItemSelector())},$rows:function(){return this.engine.$container().find(this.getRowSelector())},$loader:function(){return this.engine.$container().find(this.getLoaderSelector())},$loaderLocation:function(){return this.$rows().last()}})}),Mana.require(["jquery","singleton:Mana/Core/Layout"],function(t,e){t(function(){var o=e.getBlock("infinitescrolling-engine");if(o.getRecoverScrollProgressOnBack()){t(document).on("click","a.product-image, .product-name a",function(){var e=t("a.product-image"),o=e.index(e.withinviewport().first());"-1"!=o&&"0"!=o&&(location.hash="index="+o)});var n=location.href,i=n.split("#")[1];if(i){var r=i.split("&"),a={};r.each(function(t){var e=t.split("=")[0],o=t.split("=")[1];a[e]=o});var s=t("#m-show-more");s&&(s.remove(),o.isShowMoreButtonVisible=!1);var l=Math.floor(a.index/o.limit);window.scrollTo(null,o.getProductListBottom()),o.load(l+1,o.limit,function(){var e=t("a.product-image").eq(a.index).offset().top-10;window.scrollTo(null,e)})}}})});