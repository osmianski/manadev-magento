/**
 * @category    Mana
 * @package     Mana_InfiniteScrolling
 * @copyright   Copyright (c) http://www.manadev.com
 * @license     http://www.manadev.com/license  Proprietary License
 */
Mana.define("Mana/InfiniteScrolling/Engine",["jquery","Mana/Core/Block","singleton:Mana/Core/Ajax","singleton:Mana/Core/UrlTemplate","singleton:Mana/Core/Layout","singleton:Mana/Core/Config","singleton:Mana/Core/Json"],function(t,e,o,n,i,r,a){return e.extend("Mana/InfiniteScrolling/Engine",{scrollDisabled:!1,_init:function(){this._super(),this.debugScrolling=!1},_subscribeToHtmlEvents:function(){function e(){i.onScroll()}function o(){i.scrollDisabled=!0}function n(){i.scrollDisabled=!1}var i=this;return this._super().on("bind",this,function(){i.$pager().hide(),i.page=1,i.limit=this.getVisibleItemCount(),i.$scrollingArea().on("scroll",e),this.showShowMoreButton(),t(document).on("m-ajax-before",o).on("m-ajax-after",n)}).on("unbind",this,function(){i.$scrollingArea().off("scroll",e),t(document).off("m-ajax-before",o).off("m-ajax-after",n)})},getContainerSelector:function(){return this.$().data("container")},getRowSelector:function(){return this.getModeHandler().getRowSelector()},getProductCount:function(){return this.$().data("product-count")},getPageSize:function(){return this.$().data("page-size")},getLoaderSelector:function(){return this.getModeHandler().getLoaderSelector()},getPagerSelector:function(){return this.$().data("pager")},getUrlKey:function(){return this.$().data("url-key")},getRouteSeparator:function(){return this.$().data("route-separator")},getPageSeparator:function(){return this.$().data("page-separator")},getLimitSeparator:function(){return this.$().data("limit-separator")},getMode:function(){return this.$().data("mode")},getModeHandler:function(){if(!this.modeHandlers){this.modeHandlers={};var e=a.decodeAttribute(this.$().data("mode-handlers")),o=[],n=this;t.each(e,function(t,e){o.push(e)}),Mana.requireOptional(o,function(){var i=arguments;t.each(e,function(t,e){var r=i[o.indexOf(e)];n.modeHandlers[t]=new r(n,t)})})}return this.modeHandlers[this.getMode()]},getEffectDuration:function(){return this.$().data("effect-duration")},getNumberOfPagesWithScrollPositionRecovery:function(){return this.$().data("pages-with-scroll-position-recovery")},$container:function(){return t(this.getContainerSelector())},$pager:function(){return t(this.getPagerSelector())},$items:function(){return this.getModeHandler().$items()},$rows:function(){return this.getModeHandler().$rows()},$loaderTemplate:function(){return this.$().find(this.getLoaderSelector())},$loader:function(){return this.getModeHandler().$loader()},$loaderLocation:function(){return this.getModeHandler().$loaderLocation()},$scrollingArea:function(){return t(window)},getScrollingAreaBottom:function(){return t(window).scrollTop()+t(window).height()},getProductListBottom:function(){var t=this.$rows().last();return t.offset().top+t.height()},getVisibleItemCount:function(){return this.$items().length},getPagesPerShowMore:function(){return this.$().data("pages-per-show-more")},getRecoverScrollProgressOnBack:function(){return this.$().data("recover-scroll-progress-on-back")},getShowMoreText:function(){return this.$().data("show-more-caption")},isShowMoreButtonVisible:function(){return 0!=t("#m-show-more").length},getItemSelector:function(){return this.getContainerSelector()+" "+this.getModeHandler().getItemSelector()},showShowMoreButton:function(){var e=this;if(e.getVisibleItemCount()<e.getProductCount()&&!this.isShowMoreButtonVisible()&&e.page%e.getPagesPerShowMore()==0){var o=t("<button id='m-show-more'><span>"+e.getShowMoreText()+"</span></button>");o.insertAfter(t(this.getItemSelector()).last().parent()),o.addClass("button"),o.on("click",function(){t(this).remove(),e.load(e.page+1,e.limit)})}},getPageVarName:function(){return this.$().data("pageVarName")},getLimitVarName:function(){return this.$().data("limitVarName")},load:function(e,n,a,s){var l=this,s=s?s:!1;if(s&&(l.page=0,n=e*n,0==n))return a(),void 0;l.showLoader();var c=o.getDocumentUrl(),u=c;c=decodeURIComponent(c);var d=u.indexOf("?"),g=c.indexOf("?");-1!=d&&-1!=g&&(c=c.substr(0,g)+"?"+u.substr(d+1)),c=r.getBaseUrl(c)+this.getUrlKey()+"/"+r.getData("ajax.currentRoute")+"/"+this.getPageSeparator()+"/"+(l.page+1)+"/"+this.getLimitSeparator()+"/"+n+"/pageVarName/"+this.getPageVarName()+"/limitVarName/"+this.getLimitVarName()+"/"+this.getRouteSeparator()+"/"+c.substr(r.getBaseUrl(c).length),o.get(c,function(o){l.addContent(o,s),s?l.page=parseInt(e):l.page++,t(o).filter("script").each(function(){t.globalEval(this.innerHTML)}),"undefined"!=typeof ProductMediaManager&&"undefined"!=typeof ConfigurableMediaImages&&t(document).trigger("product-media-loaded",ProductMediaManager),l.hideLoader(),i.getPageBlock().resize(),l.page==e?(l.showShowMoreButton(),a()):(window.scrollTo(null,l.$rows().last().offset().top-20),l.load(e,n,a))},{showWait:!1,showOverlay:!1,encode:-1!=g?{offset:0,length:g}:void 0})},showLoader:function(){this.loaderVisible=!0,this.$loaderLocation().after(this.$loaderTemplate().clone())},hideLoader:function(){this.loaderVisible=!1,this.$loader().remove()},isLoaderVisible:function(){return this.loaderVisible},addContent:function(e,o){var n=t(e),i=n.find(this.getRowSelector()),r=this;i.hide();var a=t(r.$rows().parent());o&&a.html(""),r.$rows().last().removeClass("last"),i.each(function(){try{a.append(this)}catch(t){console.log("The following error occurred while trying to load next page via infinite scrolling:"),console.error(t),console.info(this)}}),i.fadeIn(this.getEffectDuration())},onScroll:function(){this.debugScrolling&&console.log("visible bottom: %d, list bottom: %d, visible count: %d, product count: %d",this.getScrollingAreaBottom(),this.getProductListBottom(),this.getVisibleItemCount(),this.getProductCount()),this.scrollDisabled||this.getVisibleItemCount()<this.getProductCount()&&this.getScrollingAreaBottom()>=this.getProductListBottom()&&!this.isLoaderVisible()&&!this.isShowMoreButtonVisible()&&this.load(this.page+1,this.limit)}})}),Mana.define("Mana/InfiniteScrolling/ModeHandler",["jquery"],function(){return Mana.Object.extend("Mana/InfiniteScrolling/ModeHandler",{_init:function(t,e){this.engine=t,this.mode=e},getItemSelector:function(){return this.engine.$().data("item-in-"+this.mode+"-mode")},getRowSelector:function(){return this.engine.$().data("row-in-"+this.mode+"-mode")},getLoaderSelector:function(){return this.engine.$().data("loader-in-"+this.mode+"-mode")},$items:function(){return this.engine.$container().find(this.getItemSelector())},$rows:function(){return this.engine.$container().find(this.getRowSelector())},$loader:function(){return this.engine.$container().find(this.getLoaderSelector())},$loaderLocation:function(){return this.$rows().last()}})}),Mana.require(["jquery","singleton:Mana/Core/Layout"],function(t,e){t(function(){function o(t){"function"==typeof jQuery&&t instanceof jQuery&&(t=t[0]);var e=t.getBoundingClientRect();return e.bottom/t.getHeight()*100>=70}var n=e.getBlock("infinitescrolling-engine");if(n){var i=n.getItemSelector();if(n.getRecoverScrollProgressOnBack()){t(document).on("click",i,function(){var e=t(i),r=0;e.each(function(t){return o(this)?(r=t,!1):void 0});var a=n.getNumberOfPagesWithScrollPositionRecovery(),s=n.limit;location.hash=!a||a*s>r?"index="+r+"&page="+n.page:"index=0&page=0"});var r=location.href,a=r.split("#")[1];if(a){var s=a.split("&"),l={};if(s.each(function(t){var e=t.split("=")[0],o=t.split("=")[1];l[e]=o}),l.page<=1)return;var c=t("#m-show-more");c&&c.remove(),window.scrollTo(null,n.getProductListBottom()),n.load(l.page,n.limit,function(){var e=setInterval(function(){function o(){var t=10,e=document.getElementsByTagName("*");for(var o in e)try{var n=jQuery.css(e[o],"position");if("fixed"==n){var i=jQuery.css(e[o],"height"),r=jQuery.css(e[o],"display"),a=jQuery.css(e[o],"top");if("0px"!=i&&"none"!=r&&"0px"==a){i=i.replace("px",""),i=parseInt(i),t=i;break}}}catch(s){}return t}var n=!0;if(t(i+" img").each(function(){t(this).height()||(n=!1)}),n){clearInterval(e);var r=o(),a=t(i).eq(l.index).offset().top-r;window.scrollTo(null,a)}},100)})}}}})});