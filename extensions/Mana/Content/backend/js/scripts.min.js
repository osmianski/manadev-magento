/**
 * @category    Mana
 * @package     Mana_Content
 * @copyright   Copyright (c) http://www.manadev.com
 * @license     http://www.manadev.com/license  Proprietary License
 */
Mana.define("Mana/Content/Folder/ListContainer",["jquery","Mana/Admin/Container"],function(e,t){return t.extend("Mana/Content/Folder/ListContainer",{_subscribeToBlockEvents:function(){return this._super().on("load",this,function(){this.getChild("create-book")&&this.getChild("create-book").on("click",this,this.createBook),this.getChild("create-feed")&&this.getChild("create-feed").on("click",this,this.createList)}).on("unload",this,function(){this.getChild("create-book")&&this.getChild("create-book").off("click",this,this.createFeed),this.getChild("create-feed")&&this.getChild("create-feed").off("click",this,this.createList)})},createBook:function(){setLocation(this.getUrl("create-book"))},createFeed:function(){setLocation(this.getUrl("create-feed"))}})}),Mana.define("Mana/Content/Book/Tree",["jquery","Mana/Core/Block","singleton:Mana/Core/Json"],function(e,t,i){return t.extend("Mana/Content/Book/Tree",{_subscribeToHtmlEvents:function(){return this._super().on("bind",this,function(){var e=this.getOptions();null==e.core.data.id&&(e.core.data.id="n"+this.createGuid()),e.core.check_callback=function(e,t,i,n,s){return s&&s.dnd&&"move_node"===e&&"#"==i.id?!1:!0},this.$().jstree(e)}).on("unbind",this,function(){})},getOptions:function(){var t={},n=this.$().data("options");return n&&e.extend(!0,t,i.decodeAttribute(n)),t},createGuid:function(){function e(){return Math.floor(10*Math.random(0,9)).toString()}return e()+e()+e()+e()+e()+e()+e()+e()}})}),Mana.define("Mana/Content/Wysiwyg",["jquery","Mana/Admin/Field/TextArea"],function(e,t){return t.extend("Mana/Content/Wysiwyg",{_subscribeToHtmlEvents:function(){function e(){function e(e){t.setValue(e.getContent())}t.useDefault()?t.disable():t.enable(),t.$editor().onKeyUp.remove(e),t.$editor().onKeyUp.add(e)}var t=this;return this._super().on("bind",this,function(){varienGlobalEvents.attachEventHandler("tinymceBeforeSetContent",e)}).on("unbind",this,function(){varienGlobalEvents.removeEventHandler("tinymceBeforeSetContent",e)})},$editor:function(){return window.tinymce.activeEditor},disable:function(){this._super(),this.$editor().getBody().setAttribute("contenteditable",!1)},enable:function(){this._super(),this.$editor().getBody().setAttribute("contenteditable",!0)}})}),Mana.define("Mana/Content/Book/TabContainer",["jquery","Mana/Admin/Container","singleton:Mana/Core/Ajax","singleton:Mana/Core","singleton:Mana/Admin/Expression"],function(e,t,i,n,s){return t.extend("Mana/Content/Book/TabContainer",{_init:function(){this._super(),this._customInit()},_customInit:function(){this._changes={created:{},modified:{},deleted:{}},this.errorPerRecord={};var t=this;e.each(this.$jsTreeElement().find("li.jstree-node"),function(){t._setNodeColor(!1,e(this).attr("id"))})},setDefaultValuesToChanges:function(){if("new"==this.getUrlParam("mana_content_book")){var e=this.initChangesObj();e.title={value:this.getText("default-title"),isDefault:1},e.url_key={value:s.seoify(this.getText("default-title")),isDefault:1},e.content={value:this.getText("default-content"),isDefault:1},this.getField("url_key").setValue(s.seoify(this.getText("default-title"))),this.getField("is_active").setValue("1")}},_subscribeToHtmlEvents:function(){var t=this,s=function(s,o){if("select_node"==o.action){var a={};a.changes=t._changes,a.id=o.node.id,a.form_key=FORM_KEY,i.post(t.getUrl("load"),a,function(s){if(n.isString(s)){var o=t.$varienTab().activeTab;t.setContent(s);var r=t.errorPerRecord[a.id]?t.errorPerRecord[a.id]:"";i.update({updates:{"#messages":r}}),t.$varienTab().showTabContent(o);for(var d=0;d<t.$varienTab().tabs.length;d++)if(t.$varienTab().tabs[d].id==o.id){e(t.$varienTab().tabs[d]).addClass("active");break}"content_tab"==t.$varienTab().activeTab.id&&t.getField("title").$field().focus(),"undefined"!=typeof wysiwygmf_content_content&&wysiwygmf_content_content.setup("exact"),t._postAction("select")}else i.update(s)})}},o=function(){var e={state:t.$jsTree().get_state(),form_key:FORM_KEY};i.post(t.getUrl("tree-save-state"),e)},a=function(i,n){var s=n.node.id,o=t.initChangesObj(s);o.parent_id={value:n.node.parent,isDefault:0},o.position={value:n.position,isDefault:0},t.$jsTree().deselect_all(),t.$jsTree().select_node(n.node.id),t.$jsTree().open_node(n.node.id),t._postAction("modify"),e.each(t.$jsTree().get_children_dom(n.node.parent),function(e,i){var n=t.initChangesObj(i.id);n.position={value:e,isDefault:0}})};return this._super().on("bind",this,function(){this.$jsTreeElement().on("changed.jstree",s),this.$jsTreeElement().on("close_node.jstree",o),this.$jsTreeElement().on("open_node.jstree",o),this.$jsTreeElement().on("move_node.jstree",a),this.setDeleteButtonText()}).on("unbind",this,function(){this.$jsTreeElement().off("changed.jstree",s),this.$jsTreeElement().off("close_node.jstree",o),this.$jsTreeElement().off("open_node.jstree",o),this.$jsTreeElement().off("move_node.jstree",a)})},isOnRootNode:function(){return this.getUrlParam("id")===this.getCurrentId()},setDeleteButtonText:function(){this.isOnRootNode()&&!this.getUrlParam("store")&&(this.$().find("button.mb-container-delete span")[0].innerHTML=this.getText("delete-whole-page"))},deleteNode:function(){var e=this.isOnRootNode()?this.getText("delete-confirm-root"):this.getText("delete-confirm");if(confirm(e)){var t=this.getCurrentId();this._isTemporaryId(t)?(delete this._changes.created[t],this.$jsTree().delete_node(t),this.$jsTree().select_node(this.getUrlParam("id"))):(delete this._changes.modified[t],this._changes.deleted[t]=t,this._setNodeColor("red"),this.isOnRootNode()&&this.saveAndClose()),this._postAction("delete")}},_initOriginalFields:function(e){(e||"undefined"==typeof this._originalFields)&&(this._originalFields={});var t=this.getCurrentId();if("undefined"==typeof this._originalFields[t]){this._originalFields[t]={};for(var i in this.getFields())this._originalFields[t][i]={},this._originalFields[t][i].value=this.getField(i).getValue(),this._originalFields[t][i].useDefault=this.getField(i).useDefault();return this._originalFields[t]}return!1},_subscribeToBlockEvents:function(){var t=["Mana_Admin_Field_Text","Mana_Admin_Field_TextArea","Mana_Admin_Field_Select","Mana_Content_Wysiwyg"];return this._super().on("load",this,function(){var i=this;e.each(this.getFields(),function(n){var s=i.getField(n);-1!==e.inArray(s.constructor.name,t)&&s&&s.on("change",i,i.fieldChanged)}),this.getChild("create")&&this.getChild("create").on("click",this,this.createChildNode),this.getChild("delete")&&this.getChild("delete").on("click",this,this.deleteNode),this.setDefaultValuesToChanges(),this._initOriginalFields(!1)}).on("unload",this,function(){var i=this;e.each(this.getFields(),function(n){var s=i.getField(n);-1!==e.inArray(s.constructor.name,t)&&s&&s.off("change",i,i.fieldChanged)}),this.getChild("create")&&this.getChild("create").off("click",this,this.createChildNode),this.getChild("delete")&&this.getChild("delete").off("click",this,this.deleteNode)})},_afterSave:function(e){var t=e.newId;for(var i in this.errorPerRecord)this.$jsTree().set_icon(i,!0);for(var n in t)this.$jsTree().set_id(n,t[n]);for(var i in this._changes.deleted)this.getCurrentId()==i&&this.$jsTree().select_node(this.getUrlParam("id")),this.$jsTree().delete_node(i);this._customInit(),this._initOriginalFields(!0)},_onSaveFailed:function(e){this.errorPerRecord=e.errorPerRecord;for(var t in this.errorPerRecord)this.$jsTree().set_icon(t,SKIN_URL+"images/mana_content/tree-icon.png")},getPostParams:function(){return{form_key:FORM_KEY,changes:this._changes,selectedRecord:this.getCurrentId(),rootPageId:this.getUrlParam("id")}},createChildNode:function(){var e={id:"n"+this.createGuid(),text:this.getText("default-title")},t=this.initChangesObj(e.id);t.id={value:e.id,isDefault:1},t.title={value:this.getText("default-title"),isDefault:1},t.url_key={value:s.seoify(this.getText("default-title")),isDefault:1},t.content={value:this.getText("default-content"),isDefault:1},t.parent_id={value:this.getCurrentId(),isDefault:1};var i=this.$jsTree().create_node(this.getCurrentId(),e);this.$jsTree().deselect_all(),this.$jsTree().select_node(i),this._setNodeColor("green")},createGuid:function(){function e(){return Math.floor(10*Math.random(0,9)).toString()}return e()+e()+e()+e()+e()+e()+e()+e()},$jsTree:function(){return this.$jsTreeElement().jstree(!0)},$jsTreeElement:function(){return e("#tree")},$varienTab:function(){return window[this.$().data("tab-id")+"JsTabs"]},getCurrentId:function(){return this.$jsTree().get_selected()[0]},initChangesObj:function(e){return void 0===e&&(e=this.getCurrentId()),this._isTemporaryId(e)?(this._changes.created[e]||(this._changes.created[e]={}),this._changes.created[e]):(this._changes.modified[e]||(this._changes.modified[e]={}),this._changes.modified[e])},getUrlParam:function(e){for(var t=window.location.toString().split("/"),i=0;i<t.length;i++)if(t[i]==e)return t[i+1];return!1},fieldChanged:function(e){function t(e){e=e.replace("_"," ");for(var t=e.split(" "),i=0;i<t.length;i++)t[i]=t[i].charAt(0).toUpperCase()+t[i].slice(1).toLowerCase();return t.join("")}var i=e.target.getName(),n=this.getField(i);this.initChangesObj()[i]={value:n.getValue(),isDefault:n.useDefault()};var s="onChange"+t(i);"function"==typeof this[s]&&this[s](),this._postAction("modify");var o=this.initChangesObj();if("undefined"!=typeof this._originalFields&&!this._isTemporaryId(this.getCurrentId())){for(var a in o){var r=this._originalFields[this.getCurrentId()][a];r.value===o[a].value&&r.useDefault===o[a].isDefault&&"undefined"!=typeof this._changes.modified[this.getCurrentId()][a]&&delete this._changes.modified[this.getCurrentId()][a]}var d=Object.keys(this._changes.modified[this.getCurrentId()]).length;0==d&&(delete this._changes.modified[this.getCurrentId()],this._setNodeColor("black"))}},onChangeUrlKey:function(){var e=this.getField("url_key"),t=this.getField("title").getValue();if("undefined"!=typeof e&&e.useDefault()){var i=s.seoify(t);e.setValue(i)}},onChangeTitle:function(){var t=this.getField("title"),i=this.getCurrentId(),n=t.getValue(),s=parseInt(this.$().data("visible-title-char"));e("#"+i).attr("title",n),n.length>s&&(n=n.substring(0,s),n+="..."),this.onChangeUrlKey(),this.onChangeMetaTitle(),this.$jsTree().rename_node(i,n),this.$().find("div.content-header tr:first h3.head-empty")[0].innerHTML=t.getValue()+" - Book"},onChangeMetaTitle:function(){var e=this.getField("meta_title");"undefined"!=typeof e&&e.useDefault()&&e.setValue(this.getField("title").getValue())},_isTemporaryId:function(e){return"n"===e.charAt(0)},_setNodeColor:function(t,i){i=void 0===i?this.getCurrentId():i;var n=this.$jsTree().get_node(i).li_attr,s="node-color-";n.class||(n.class=[]);for(var o=0;o<n.class.length;o++)n.class[o].startsWith(s)&&(e("#"+i).removeClass(n.class[o]),n.class.splice(o,1));if(t){var a=s+t;n.class.push(a),e("#"+i).addClass(a)}},_postAction:function(e){switch(e){case"delete":"all"!==this.getText("save-mode")&&this.save();break;case"modify":this._isTemporaryId(this.getCurrentId())||void 0!==this._changes.deleted[this.getCurrentId()]||this._setNodeColor("blue"),"field"===this.getText("save-mode")&&this.save();break;case"select":"page"===this.getText("save-mode")&&this.save()}}})}),Mana.define("Mana/Content/Book/TabContainer/Global",["jquery","Mana/Content/Book/TabContainer"],function(e,t){return t.extend("Mana/Content/Book/TabContainer/Global",{})}),Mana.define("Mana/Content/Book/TabContainer/Store",["jquery","Mana/Content/Book/TabContainer"],function(e,t){return t.extend("Mana/Content/Book/TabContainer/Store",{})});