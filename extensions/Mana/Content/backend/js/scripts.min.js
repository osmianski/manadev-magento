/**
 * @category    Mana
 * @package     Mana_Content
 * @copyright   Copyright (c) http://www.manadev.com
 * @license     http://www.manadev.com/license  Proprietary License
 */
Mana.define("Mana/Content/Folder/ListContainer",["jquery","Mana/Admin/Container"],function(e,t){return t.extend("Mana/Content/Folder/ListContainer",{_subscribeToBlockEvents:function(){return this._super().on("load",this,function(){this.getChild("create-book")&&this.getChild("create-book").on("click",this,this.createBook),this.getChild("create-feed")&&this.getChild("create-feed").on("click",this,this.createList)}).on("unload",this,function(){this.getChild("create-book")&&this.getChild("create-book").off("click",this,this.createFeed),this.getChild("create-feed")&&this.getChild("create-feed").off("click",this,this.createList)})},createBook:function(){setLocation(this.getUrl("create-book"))},createFeed:function(){setLocation(this.getUrl("create-feed"))}})}),Mana.define("Mana/Content/Book/Tree",["jquery","Mana/Core/Block","singleton:Mana/Core/Json","singleton:Mana/Core/Layout"],function(e,t,i,n){return t.extend("Mana/Content/Book/Tree",{_subscribeToHtmlEvents:function(){return this._super().on("bind",this,function(){var e=this.getOptions();null==e.core.data.id&&(e.core.data.id="n"+this.createGuid());var t=this.$container();t.startingId=e.core.data.id;var i=this;e.core.check_callback=function(e,n,s,r,a){return a&&a.dnd&&("move_node"===e||"copy_node"===e)&&("#"==s.id||("move_node"===e&&t.triggerReference||"copy_node"===e)&&n.children.length>0||("move_node"===e||"copy_node"===e)&&i.isTargetReferencePage(s))?!1:!0},this.$().jstree(e)}).on("unbind",this,function(){})},isTargetReferencePage:function(e){var t=this.$container().reference_pages;for(var i in t)if(t[i].id==e.id||t[i].reference_id==e.id)return!0;return!1},$container:function(){return n.getBlock("container")},getOptions:function(){var t={},n=this.$().data("options");return n&&e.extend(!0,t,i.decodeAttribute(n)),t},createGuid:function(){function e(){return Math.floor(10*Math.random(0,9)).toString()}return e()+e()+e()+e()+e()+e()+e()+e()}})}),Mana.define("Mana/Content/Wysiwyg",["jquery","Mana/Admin/Field/TextArea"],function(e,t){return t.extend("Mana/Content/Wysiwyg",{_subscribeToHtmlEvents:function(){function e(){function e(e){t.setValue(e.getContent())}t.useDefault()?t.disable():t.enable(),t.$editor().onKeyUp.remove(e),t.$editor().onKeyUp.add(e)}var t=this;return this._super().on("bind",this,function(){varienGlobalEvents.attachEventHandler("tinymceBeforeSetContent",e)}).on("unbind",this,function(){varienGlobalEvents.removeEventHandler("tinymceBeforeSetContent",e)})},$editor:function(){return window.tinymce.activeEditor},disable:function(){this._super(),this.$editor().getBody().setAttribute("contenteditable",!1)},enable:function(){this._super(),this.$editor().getBody().setAttribute("contenteditable",!0)}})}),Mana.define("Mana/Content/Book/TabContainer",["jquery","Mana/Admin/Container","singleton:Mana/Core/Ajax","singleton:Mana/Core","singleton:Mana/Admin/Expression"],function(e,t,i,n,s){return t.extend("Mana/Content/Book/TabContainer",{_init:function(){this._super(),this._customInit()},_customInit:function(){this._changes={created:{},modified:{},deleted:{}},this.errorPerRecord={},this.triggerReference=!1,this.useReferenceInsteadOfCopy=!1,this.startingId=!1;var t=this;e.each(this.$jsTreeElement().find("li.jstree-node"),function(){t._setNodeColor(!1,e(this).attr("id"))})},setDefaultValuesToChanges:function(){if("new"==this.getUrlParam("mana_content_book")){var e=this.initChangesObj();e.title={value:this.getText("default-title"),isDefault:1},e.content={value:this.getText("default-content"),isDefault:1},this.onChangeTitle(),this.getField("is_active")&&this.getField("is_active").setValue("1")}},_subscribeToHtmlEvents:function(){var t=this,s=function(s,r){if("select_node"==r.action){var a={};a.changes=t._changes,a.id=r.node.id,a.form_key=FORM_KEY,i.post(t.getUrl("load"),a,function(s){if(n.isString(s)){var r=t.$varienTab().activeTab,o=t.reference_pages;t.setContent(s),t.reference_pages=o;var d=t.errorPerRecord[a.id]?t.errorPerRecord[a.id]:"";i.update({updates:{"#messages":d}}),t.$varienTab().showTabContent(r);for(var l=0;l<t.$varienTab().tabs.length;l++)if(t.$varienTab().tabs[l].id==r.id){e(t.$varienTab().tabs[l]).addClass("active");break}"content_tab"==t.$varienTab().activeTab.id&&t.getField("title").$field().focus(),"undefined"==typeof wysiwygmf_content_content||t.isReferencePage()||wysiwygmf_content_content.setup("exact"),t._postAction("select")}else i.update(s)})}},r=function(){var e={state:t.$jsTree().get_state(),form_key:FORM_KEY};i.post(t.getUrl("tree-save-state"),e)},a=function(i,n){var s,r=n.node.id;s=t.initChangesObj(r),s.parent_id={value:n.node.parent,isDefault:0},s.position={value:n.position,isDefault:0},e.each(t.$jsTree().get_children_dom(n.node.parent),function(e,i){var n=t.initChangesObj(i.id);n.position={value:e,isDefault:0}})},o=function(n,s){function r(i){var n=e.extend({},i);"undefined"==typeof n.reference_id||null!==n.reference_id.value&&"0"!=n.reference_id.value||delete n.reference_id;var r="undefined"!=typeof n.reference_id?n.reference_id:n.id;delete n.id,n=t.createNewRecord(n),n.parent_id={value:s.parent,isDefault:1},n.position={value:s.position,isDefault:1},t.useReferenceInsteadOfCopy&&(t.useReferenceInsteadOfCopy=!1,n.reference_id=r,t.reference_pages.push({id:n.id.value,reference_id:n.reference_id.value})),t.$jsTree().set_id(s.node.id,n.id.value),t._setNodeColor("green",n.id.value),t.$jsTree().deselect_all(),t.$jsTree().select_node(n.id.value)}t.triggerReference&&(t.triggerReference=!1,t.useReferenceInsteadOfCopy=!0);var a;if(t._isTemporaryId(s.original.id)){var o=t.initChangesObj(s.original.id);r(o)}else{a=s.original.id;var d={form_key:FORM_KEY,id:a};i.post(t.getUrl("getRecord"),d,function(e){r(e.data)})}},d=function(e,i){t.triggerReference=i.event.altKey},l=function(e){var e=e?e:event?event:null;return 13==e.keyCode?!1:void 0};return this._super().on("bind",this,function(){this.$jsTreeElement().on("changed.jstree",s),this.$jsTreeElement().on("close_node.jstree",r),this.$jsTreeElement().on("open_node.jstree",r),this.$jsTreeElement().on("move_node.jstree",a),this.$jsTreeElement().on("copy_node.jstree",o),this.$().find("#mf_content_title").on("keypress",l),e(document).on("dnd_move.vakata",d),this.setDeleteButtonText(),this.reference_pages=this.$().data("reference-pages")}).on("unbind",this,function(){this.$jsTreeElement().off("changed.jstree",s),this.$jsTreeElement().off("close_node.jstree",r),this.$jsTreeElement().off("open_node.jstree",r),this.$jsTreeElement().off("move_node.jstree",a),this.$jsTreeElement().off("copy_node.jstree",o),this.$().find("#mf_content_title").off("keypress",l),e(document).off("dnd_move.vakata",d)})},isOnRootNode:function(){return this.getUrlParam("id")===this.getCurrentId()},isReferencePage:function(){var e=this.getField("reference_id").getValue();return""!==e},disableFieldsIfReferencePage:function(){if(this.isReferencePage()){var t=this;e.each(this.getFields(),function(e){var i=t.getField(e);i.disable(),i.$useDefault().parent().hide(),"undefined"!=typeof i.$picker&&i.$picker().hide()})}},setDeleteButtonText:function(){this.isOnRootNode()&&!this.getUrlParam("store")&&(this.$().find("button.mb-container-delete span")[0].innerHTML=this.getText("delete-whole-page"))},deleteNode:function(){var e=this.isOnRootNode()?this.getText("delete-confirm-root"):this.getText("delete-confirm");if(confirm(e)){var t=this.getCurrentId();for(var i in this.reference_pages)if(t==this.reference_pages[i].reference_id){var n=this.reference_pages[i];this._isTemporaryId(n.id)?(delete this._changes.created[n.id],this.$jsTree().delete_node(n.id)):(this._changes.deleted[n.id]=n.id,this._setNodeColor("red",n.id))}this._isTemporaryId(t)?(delete this._changes.created[t],this.$jsTree().delete_node(t),this.$jsTree().select_node(this.getUrlParam("id"))):(delete this._changes.modified[t],this._changes.deleted[t]=t,this._setNodeColor("red"),this.isOnRootNode()&&this.saveAndClose()),this._postAction("delete")}},_initOriginalFields:function(e){(e||"undefined"==typeof this._originalFields)&&(this._originalFields={});var t=this.getCurrentId();if("undefined"==typeof this._originalFields[t]){this._originalFields[t]={};for(var i in this.getFields())this._originalFields[t][i]={},this._originalFields[t][i].value=this.getField(i).getValue(),this._originalFields[t][i].useDefault=this.getField(i).useDefault();return this._originalFields[t]}return!1},goToOriginalPage:function(){var e=this.getField("reference_id").getValue();this.$jsTree().deselect_all(),this.$jsTree().select_node(e)},_subscribeToBlockEvents:function(){var t=["Mana_Admin_Field_Text","Mana_Admin_Field_TextArea","Mana_Admin_Field_Select","Mana_Content_Wysiwyg"];return this._super().on("load",this,function(){var i=this;e.each(this.getFields(),function(n){var s=i.getField(n);-1!==e.inArray(s.constructor.name,t)&&s&&s.on("change",i,i.fieldChanged)}),this.getChild("create")&&this.getChild("create").on("click",this,this.createChildNode),this.getChild("delete")&&this.getChild("delete").on("click",this,this.deleteNode),this.getChild("goToOriginal")&&this.getChild("goToOriginal").on("click",this,this.goToOriginalPage),this.setDefaultValuesToChanges(),this._initOriginalFields(!1),this.disableFieldsIfReferencePage()}).on("unload",this,function(){var i=this;e.each(this.getFields(),function(n){var s=i.getField(n);-1!==e.inArray(s.constructor.name,t)&&s&&s.off("change",i,i.fieldChanged)}),this.getChild("create")&&this.getChild("create").off("click",this,this.createChildNode),this.getChild("delete")&&this.getChild("delete").off("click",this,this.deleteNode),this.getChild("goToOriginal")&&this.getChild("goToOriginal").off("click",this,this.goToOriginalPage)})},_afterSave:function(e){var t=e.newId;for(var i in this.errorPerRecord)this.$jsTree().set_icon(i,!0);for(var n in t){this.$jsTree().set_id(n,t[n]);for(var s in this.reference_pages)this.reference_pages[s].id==n&&(this.reference_pages[s].id=t[n]),this.reference_pages[s].reference_id==n&&(this.reference_pages[s].reference_id=t[n])}for(var i in this._changes.deleted)this.getCurrentId()==i&&this.$jsTree().select_node(this.getUrlParam("id")),this.$jsTree().delete_node(i);this._customInit(),this._initOriginalFields(!0)},_onSaveFailed:function(e){this.errorPerRecord=e.errorPerRecord;for(var t in this.errorPerRecord)this.$jsTree().set_icon(t,SKIN_URL+"images/mana_content/tree-icon.png");for(var i in this.errorPerRecord){this.getCurrentId()!=i&&(this.$jsTree().deselect_all(),this.$jsTree().select_node(i));break}},getPostParams:function(){return{form_key:FORM_KEY,changes:this._changes,selectedRecord:this.getCurrentId(),rootPageId:this.getUrlParam("id")}},createNewRecord:function(t){t=t?t:{},t.id=t.id?t.id:{value:"n"+this.createGuid(),isDefault:1};var i=this.initChangesObj(t.id.value);return i.title={value:this.getText("default-title"),isDefault:1},i.url_key={value:s.seoify(this.getText("default-title")),isDefault:1},i.content={value:this.getText("default-content"),isDefault:1},i.parent_id={value:this.getCurrentId(),isDefault:1},e.extend(i,t)},createChildNode:function(){var e=this.createNewRecord(),t={id:e.id.value,text:e.title.value},i=this.$jsTree().create_node(this.getCurrentId(),t);this.$jsTree().deselect_all(),this.$jsTree().select_node(i),this._setNodeColor("green")},createGuid:function(){function e(){return Math.floor(10*Math.random(0,9)).toString()}return e()+e()+e()+e()+e()+e()+e()+e()},$jsTree:function(){return this.$jsTreeElement().jstree(!0)},$jsTreeElement:function(){return e("#tree")},$varienTab:function(){return window[this.$().data("tab-id")+"JsTabs"]},getCurrentId:function(){return"undefined"==typeof this.$jsTree().get_selected()[0]?this.startingId:this.$jsTree().get_selected()[0]},initChangesObj:function(e){return void 0===e&&(e=this.getCurrentId()),this._isTemporaryId(e)?(this._changes.created[e]||(this._changes.created[e]={},this._changes.created[e].related_products=[]),this._changes.created[e]):(this._changes.modified[e]||(this._changes.modified[e]={},this._changes.modified[e].related_products=[]),this._changes.modified[e])},getUrlParam:function(e){for(var t=window.location.toString().split("/"),i=0;i<t.length;i++)if(t[i]==e)return t[i+1];return!1},setToBlackIfNoChanges:function(){var e=this.initChangesObj();if("undefined"!=typeof this._originalFields&&!this._isTemporaryId(this.getCurrentId())){for(var t in e){var i=this._originalFields[this.getCurrentId()][t];"undefined"!=typeof i&&i.value===e[t].value&&i.useDefault===e[t].isDefault&&"undefined"!=typeof this._changes.modified[this.getCurrentId()][t]&&delete this._changes.modified[this.getCurrentId()][t]}"undefined"!=typeof e.related_products&&0==e.related_products.length&&delete e.related_products;var n=Object.keys(this._changes.modified[this.getCurrentId()]).length;0==n&&(delete this._changes.modified[this.getCurrentId()],this._setNodeColor("black")),"undefined"!=typeof e.related_products&&(e.related_products=[])}},fieldChanged:function(e){function t(e){e=e.replace("_"," ");for(var t=e.split(" "),i=0;i<t.length;i++)t[i]=t[i].charAt(0).toUpperCase()+t[i].slice(1).toLowerCase();return t.join("")}var i=e.target.getName(),n=this.getField(i);this.initChangesObj()[i]={value:n.getValue(),isDefault:n.useDefault()};var s="onChange"+t(i);"function"==typeof this[s]&&this[s](),this._postAction("modify"),this.setToBlackIfNoChanges()},onChangeUrlKey:function(){var e=this.getField("url_key"),t=this.getField("title").getValue(),i=s.seoify(t);"undefined"!=typeof e&&e.useDefault()&&e.setValue(i),"undefined"==typeof e&&(this.initChangesObj().url_key={value:i,isDefault:1},this.setToBlackIfNoChanges())},onChangeTitle:function(){var t=this.getField("title"),i=this.getCurrentId(),n=t.getValue(),s=parseInt(this.$().data("visible-title-char"));e("#"+i).attr("title",n),n.length>s&&(n=n.substring(0,s),n+="..."),this.onChangeUrlKey(),this.onChangeMetaTitle(),this.$jsTree().rename_node(i,n);for(var r in this.reference_pages)this.reference_pages[r].reference_id==i&&this.$jsTree().rename_node(this.reference_pages[r],n);this.$().find("div.content-header tr:first h3.head-empty")[0].innerHTML=t.getValue()+" - Book"},onChangeMetaTitle:function(){var e=this.getField("meta_title");"undefined"!=typeof e&&e.useDefault()&&e.setValue(this.getField("title").getValue())},onChangeTags:function(){var e=this.getField("meta_keywords");"undefined"!=typeof e&&e.useDefault()&&e.setValue(this.getField("tags").getValue())},onChangeMetaKeywords:function(){this.onChangeTags()},_isTemporaryId:function(e){return"n"===e.charAt(0)},_setNodeColor:function(t,i){i=void 0===i?this.getCurrentId():i;var n=this.$jsTree().get_node(i).li_attr,s="node-color-";n.class||(n.class=[]);for(var r=0;r<n.class.length;r++)n.class[r].startsWith(s)&&(e("#"+i).removeClass(n.class[r]),n.class.splice(r,1));if(t){var a=s+t;n.class.push(a),e("#"+i).addClass(a)}},_postAction:function(e){switch(e){case"delete":"all"!==this.getText("save-mode")&&this.save();break;case"modify":this._isTemporaryId(this.getCurrentId())||void 0!==this._changes.deleted[this.getCurrentId()]||this._setNodeColor("blue"),"field"===this.getText("save-mode")&&this.save();break;case"select":"page"===this.getText("save-mode")&&this.save()}}})}),Mana.define("Mana/Content/Book/TabContainer/Global",["jquery","Mana/Content/Book/TabContainer"],function(e,t){return t.extend("Mana/Content/Book/TabContainer/Global",{})}),Mana.define("Mana/Content/Book/TabContainer/Store",["jquery","Mana/Content/Book/TabContainer","singleton:Mana/Admin/Expression"],function(e,t,i){return t.extend("Mana/Content/Book/TabContainer/Store",{onChangeTitle:function(){var e=this.getField("title");e.useDefault()&&e.setValue(this.getJsonData("global","title")),this._super()},onChangeUrlKey:function(){var e=this.getField("url_key");if("undefined"!=typeof e&&e.useDefault())if(this.getJsonData("global-is-custom","url_key"))e.setValue(this.getJsonData("global","url_key"));else{var t=this.getField("title").getValue(),n=i.seoify(t);e.setValue(n)}"undefined"==typeof e&&(this.initChangesObj().url_key={value:n,isDefault:1},this.setToBlackIfNoChanges())},onChangeMetaTitle:function(){var e=this.getField("meta_title");if("undefined"!=typeof e&&e.useDefault())if(this.getJsonData("global-is-custom","meta_title"))e.setValue(this.getJsonData("global","meta_title"));else{var t=this.getField("title").getValue();e.setValue(t)}},onChangeTags:function(){var e=this.getField("meta_keywords");"undefined"!=typeof e&&e.useDefault()&&(this.getJsonData("global-is-custom","meta_keywords")?e.setValue(this.getJsonData("global","meta_keywords")):e.setValue(this.getField("tags").getValue()))}})});